<!doctype html>
<html>
<head>
    <title></title>

    <style type="text/css">
        body {
            font-family : Verdana, "Bitstream Vera Sans", "DejaVu Sans", Tahoma, Geneva, Arial, Sans-serif;
            font-size: 13px;
            min-width:1000px;
        }


        /*.vis.timeline .item.background {*/
            /*background-color: rgba(40, 148, 255, 0.20) !important;*/
            /*z-index:9999 !important;*/
        /*}*/
        .vis.timeline .item.background.prediction {
            border: 1px solid rgba(0, 164, 255, 0.50) !important;
            background-color: rgba(0, 164, 255, 0.10) !important;
            box-shadow: rgba(0, 83, 128, 0.15) 0px 0px 10px !important;
            /*z-index:9999 !important;*/
            height:34px !important;
        }
        .vis.timeline .item.background.night {
            background-color: rgba(60, 60, 60, 0.3) !important;
            z-index:9999 !important;
        }
        .vis.timeline .labelset .timelineGroup .inner {
             /*height:100px !important;*/
             width:140px !important;
         }

        .vis.timeline .labelset .timelineGroup.worker{
             background-color: #ffffff;
         }
        .vis.timeline .labelset .timelineGroup.rao{
            background-color: #f5f5f5;
        }
        .vis.timeline .labelset .timelineGroup.pm{
            background-color: #dfeaf2;
        }
        .vis.timeline .labelset .timelineGroup.mt{
            background-color: #b8d6e6;
        }

        .vis.timeline .item.range {
            height:34px !important;
        }

        .vis.timeline .item.range.pause{
            height:34px !important;
            width:26px !important;
            box-shadow: rgba(0,0,0,0.2) 0px 0px 10px !important;
            padding:3px !important;
            z-index:999999;
            background-color: #ffffff !important
        }

        .vis.timeline .item {
            border-radius: 0px !important;
            border-color: #7d807d !important;
            background-color: #ffffff !important;
            /*background-color: #c4e0ff !important;*/
        }
        .vis.timeline .item.box {
            height:22px !important;
            border-radius: 0px !important;
            border-color: #7d807d !important;
            background-color: #ffffff !important;
        }

        img.icon{
            width:16px;
            height:16px;
        }

        #multiselect {
            width:200px;
            height:500px;
        }

        table.wrapper {
            position:relative;
            height:500px;
            width:100%;
        }

        #selectTD {
            width:200px;
        }

        div.typeButtons {
            height:50px;
            width:100%;
            overflow:hidden;
        }

        div.typeButton {
            display:inline-block;
            width:150px;
            height:24px;
            border:2px solid #ffffff;
            border-radius: 40px;
            text-align:center;
            font-size:12px;
            color: #848484;
            padding-top:8px;
            background-color: #dedede;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor:pointer;
            margin:5px;
            box-shadow: rgba(50,50,50,0.3) 0px 0px 3px;
        }

        div.typeButton.selected {
            background-color: #9aff4d;
            color: #000000;
        }

        div.toggleButton {
            background-image: url("./images/toggleOff.png");
            background-repeat: no-repeat;
            background-position: 5px 4px;
            display:inline-block;
            width:130px;
            height:28px;
            font-size:12px;
            border:1px solid #d0d0d0;
            text-align:right;
            padding-top:12px;
            padding-right:40px;
            border-radius: 40px;
            background-color: #ffffff;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor:pointer;
        }

        div.toggleButton.selected {
            background-image: url("./images/toggleOn.png");
            background-color: #ffffff;
        }

        div.graph2dContent{
            display:inline-block;
            height:450px;
            width:100%;
        }

        #graphWrapper {
            display:none;
            border: 1px solid #dddddd;
            padding:5px;
        }

        #timelineWrapper {
            display:block;
            border: 1px solid #dddddd;
            padding:5px;
        }

        /*.prediction {*/
            /*fill: #ff9f26;*/
            /*fill-opacity:0;*/
            /*stroke-width:2px;*/
            /*stroke: #ff9f26;*/
        /*}*/

        /*.prediction_original {*/
            /*fill: #77da2e;*/
            /*fill-opacity:0;*/
            /*stroke-width:2px;*/
            /*stroke: #77da2e;*/
        /*}*/

        /*.prediction_std {*/
            /*fill: rgba(255, 159, 38, 0.5);*/
            /*fill-opacity:0;*/
            /*stroke-width:2px;*/
            /*stroke: rgba(255, 159, 38, 0.5);*/
        /*}*/

        /*.duration {*/
            /*fill: #5992ff;*/
            /*fill-opacity:0;*/
            /*stroke-width:2px;*/
            /*stroke: #5992ff;*/
        /*}*/

        .prediction_original {
            fill: rgb(123, 199, 255);
            fill-opacity:0;
            stroke-width:2px;
            stroke: rgb(123, 199, 255);
        }

        .prediction {
            fill: #77da2e;
            fill-opacity:0;
            stroke-width:2px;
            stroke: #77da2e;
        }

        .duration {
            fill: rgb(170, 34, 206);
            fill-opacity:0;
            stroke-width:2px;
            stroke: rgb(170, 34, 206);
        }

        .fill {
            fill-opacity:0.1;
            stroke: none;
        }


        .bar {
            fill-opacity:0.5;
            stroke-width:1px;
        }

        .point {
            stroke-width:2px;
            fill-opacity:1.0;
        }


        .legendBackground {
            stroke-width:1px;
            fill-opacity:0.9;
            fill: #ffffff;
            stroke: #c2c2c2;
        }


        .outline {
            stroke-width:1px;
            fill-opacity:1;
            fill: #ffffff;
            stroke: #e5e5e5;
        }

        .iconFill {
            fill-opacity:0.3;
            stroke: none;
        }

        div.descriptionContainer {
            float:left;
            height:30px;
            min-width:160px;
            padding-left:5px;
            padding-right:5px;
            line-height: 30px;
        }

        div.iconContainer {
            float:left;
        }

        div.legendElementContainer {
            display:inline-block;
            height:30px;
            border-style:solid;
            border-width:1px;
            border-color: #e0e0e0;
            background-color: #ffffff;
            margin:4px;
            padding:4px;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor:pointer;
        }

        svg.legendIcon {
            width:30px;
            height:30px;
        }

        div.externalLegend {
            position:relative;
            margin-top:-5px;
            margin-left: 203px;
            width: 900px;
        }

        .differencePositive {
            fill: #afff33;
            stroke-width:2px;
            stroke: #96db22;
        }

        .differenceNegative {
            fill: #ff9f00;
            stroke-width:2px;
            stroke: #e58f00;
        }

    </style>

    <script type="text/javascript" src="vis.js"></script>
    <script type="text/javascript" src="evejs.js"></script>
    <script type="text/javascript" src="./arumAgents/job.js"></script>
    <script type="text/javascript" src="./arumAgents/durationStats.js"></script>
    <script type="text/javascript" src="./arumAgents/durationData.js"></script>
    <script type="text/javascript" src="./arumAgents/jobManager.js"></script>
    <script type="text/javascript" src="./arumAgents/jobAgent.js"></script>

    <script type="text/javascript">
        'use strict';
        var timeline;
        var timelineItems = new vis.DataSet();
        var timelineGroups = new vis.DataSet();

        var graph2d;
        var graph2dDataset = [];
        var graph2DItems = new vis.DataSet();
        var graph2dGroups = new vis.DataSet();
        graph2dGroups.add({
            id: 'differencePositive', content: 'differencePositive', className: "differencePositive", options: {
                drawPoints: false,
                style: 'bar',
                barChart: {width: 50, align: 'center'} // align: left, center, right
            }
        })
        graph2dGroups.add({
            id: 'differenceNegative', content: 'differenceNegative', className: "differenceNegative", options: {
                drawPoints: false,
                style: 'bar',
                barChart: {width: 50, align: 'center'} // align: left, center, right
            }
        })
        var eventCounter;

        var selectedGroup = 'duration';
        var showDuration = true;
        var showPrediction = false;
        var showTimeline = true;
        var showGraph = false;
        var differenceWithPrediction = false;

        function draw() {
            eventCounter = document.getElementById('eventCounter');

            // add items to the DataSet
            var timelineContainer = document.getElementById('timeline');
            var timelineOptions = {
                start: '2014-09-21',
                end: '2014-09-23',
                autoResize: false,
                showCustomTime: true,
                showCurrentTime: false,
                stack: false
            }
            timeline = new vis.Timeline(timelineContainer, timelineItems, timelineOptions, timelineGroups);

            var graph2dContainer = document.getElementById('graph2d');
            var graph2dOptions = {
                style:'bar',
                barChart: {width:50, align:'center', handleOverlap:'sideBySide'},
                start: '2014-08-25',
                end: '2014-09-25',
                autoResize: false,
//                height: '450px',
                showCurrentTime: false,
                catmullRom: false,
                showMajorLabels: false,
                showMinorLabels: false,
                graphHeight:'450px',
                dataAxis: {
                    customRange: {
                        left: {
                            min:-0.1
                        }
                    }
                },
                drawPoints:false //{style:'circle'}
            }
            graph2d = new vis.Graph2d(graph2dContainer, graph2DItems, graph2dGroups, graph2dOptions);
        }

        var JAVA_EVENTS_URL = 'ws://localhost:8082/ws/events';
        var AMOUNT_OF_INITIAL_EVENTS = 1;
        var conn;

        eve.system.init({
            transports: [
                {
                    type: 'ws'
                }
            ]
        });

    </script>
    <script type="text/javascript" src="./arumAgents/genericAgent.js"></script>
    <script type="text/javascript" src="./arumAgents/agentGenerator.js"></script>
    <script type="text/javascript" src="./arumAgents/jobAgentGenerator.js"></script>
    <script type="text/javascript" src="./arumAgents/eventGenerator.js"></script>

    <script>
        var agentList = {};
        var jobList = {};
        var agentGen = new AgentGenerator("agentGenerator");
        var jobGen = new JobAgentGenerator("jobAgentGenerator");
        var eventGen = new EventGenerator("frank");


//        eventGen.start();
        function getNewEvent() {
            agentGen.getEvents(1);
        }

        function getTenNewEvents() {
            agentGen.getEvents(10);
        }

        function getAllEvents() {
            agentGen.getEvents(agentGen.amountOfEvents);
        }

        function refreshJobs() {
            var multiSelect = document.getElementById("multiselect");
            while (multiSelect.firstChild) {
                multiSelect.removeChild(multiSelect.firstChild);
            }
            var jobNames = jobGen.getAllJobNames();
            for (var i = 0; i < jobNames.length; i++) {
                var jobOption = new Option(jobNames[i], jobNames[i]);
                multiSelect.appendChild(jobOption);
            }
        }

        function updateGraph() {
            var multiSelect = document.getElementById("multiselect");
            var selection = [];
            for (var i = 0; i < multiSelect.children.length; i++) {
                if (multiSelect.children[i].selected) {
                    selection.push(multiSelect.children[i].value);
                }
            }

            var filteredValues = [];
            var originalPredictionValues = [];
            var durationValues = [];
            var predictionValues = [];
            var diffValues = [];
            var graphGroup = null;
            var stdGroup = null;
            var predictionGroup = null;
            var originalPredictionGroup = null;
            for (var i = 0; i < graph2dDataset.length; i++) {
                if (selection.indexOf(graph2dDataset[i].type) != -1) {
                    if (showDuration == true) {
                        if (graph2dDataset[i].group == graph2dDataset[i].type + "_" + selectedGroup) {
                            filteredValues.push(graph2dDataset[i]);
                            durationValues.push(graph2dDataset[i]);
                            graphGroup =  graph2dDataset[i].group;
                        }
                    }
                    if (showPrediction == true) {
                        if (graph2dDataset[i].group == graph2dDataset[i].type + "_pred_" + selectedGroup) {
                            filteredValues.push(graph2dDataset[i]);
                            predictionValues.push(graph2dDataset[i]);
                            predictionGroup = graph2dDataset[i].group;
                        }
                        if (graph2dDataset[i].group == graph2dDataset[i].type + "_pred_" + selectedGroup + "_std_higher") {
                            filteredValues.push(graph2dDataset[i]);
                            stdGroup = graph2dDataset[i].group;
                        }
                        if (graph2dDataset[i].group == graph2dDataset[i].type + "_pred_" + selectedGroup + "_std_lower") {
                            filteredValues.push(graph2dDataset[i]);
                            stdGroup = graph2dDataset[i].group;
                        }
                        if (graph2dDataset[i].group == graph2dDataset[i].type + "_pred_" + selectedGroup + "_original") {
                            filteredValues.push(graph2dDataset[i]);
                            originalPredictionValues.push(graph2dDataset[i]);
                            originalPredictionGroup = graph2dDataset[i].group;
                        }
                    }
                }
            }

            graph2DItems.clear();
            if (differenceWithPrediction == true) {
                for (var i = 0; i < durationValues.length; i++) {
                    var item = {};
                    item.x = i < 10 ? '2014-09-0' + i :'2014-09-' + i;
                    item.y = durationValues[i].y;
                    item.type = durationValues[i].type;
                    item.y -= originalPredictionValues[i].y;
                    var group = 'differenceNegative';
                    if (item.y < 0) {
                        item.y *= -1;
                        group = 'differencePositive'
                    }
                    item.group = group;
                    diffValues.push(item);
                }
                var legendDiv = document.getElementById("Legend");
                legendDiv.innerHTML = "";
                populateExternalLegend('differencePositive', "Faster than predicted (hours)");
                populateExternalLegend('differenceNegative', "Slower than predicted (hours)");
                graph2DItems.add(diffValues);
            }
            else {
                var filteredValues = [];
                for (var i = 0; i < durationValues.length; i++) {
                    var durationItem = {};
                    durationItem.x = i < 10 ? '2014-09-0' + i :'2014-09-' + i;
                    durationItem.y = durationValues[i].y;
                    durationItem.type = durationValues[i].type;
                    durationItem.group = durationValues[i].group;
                    filteredValues.push(durationItem);
                    if (showPrediction == true) {
                        var predItem = {};
                        predItem.x =  i < 10 ? '2014-09-0' + i :'2014-09-' + i;
                        predItem.y = predictionValues[i].y;
                        predItem.type = predictionValues[i].type;
                        predItem.group = predictionValues[i].group;
                        filteredValues.push(predItem);

                        var originalPred = {};
                        originalPred.x =  i < 10 ? '2014-09-0' + i :'2014-09-' + i;
                        originalPred.y = originalPredictionValues[i].y;
                        originalPred.type = originalPredictionValues[i].type;
                        originalPred.group = originalPredictionValues[i].group;
                        filteredValues.push(originalPred);
                    }
                }
                var legendDiv = document.getElementById("Legend");
                legendDiv.innerHTML = "";
                if (graphGroup != null)              {populateExternalLegend(graphGroup, "duration (hours)");}
//                if (stdGroup != null)                {populateExternalLegend(stdGroup, "standard deviation");}
                if (predictionGroup != null)         {populateExternalLegend(predictionGroup, "updated prediction (hours)");}
                if (originalPredictionGroup != null) {populateExternalLegend(originalPredictionGroup, "initial prediction (hours)");}
                graph2DItems.add(filteredValues);
            }
            graph2d.fit();

        }

        function turnOff(type) {
            var btn = document.getElementById(type);
            btn.className = btn.className.replace(" selected","");
        }

        function turnOffAll() {
            var types = ['duration','durationWithPause','durationWithStartup','durationWithBoth'];
            for (var i = 0; i < types.length; i++) {
                turnOff(types[i]);
            }
        }

        function turnOn(type) {
            turnOffAll();
            var btn = document.getElementById(type);
            selectedGroup = type;
            btn.className += " selected";
            updateGraph();
        }

        function togglePrediction() {
            if (differenceWithPrediction != true) {
                var btn = document.getElementById('togglePrediction');
                if (showPrediction == true) {
                    btn.className = btn.className.replace("selected", "");
                    showPrediction = false;
                }
                else {
                    showPrediction = true;
                    btn.className += " selected";
                }
                updateGraph();
            }
        }
        function toggleDuration() {
            if (differenceWithPrediction != true) {
                var btn = document.getElementById('toggleDuration');
                if (showDuration == true) {
                    btn.className = btn.className.replace("selected", "");
                    showDuration = false;
                }
                else {
                    showDuration = true;
                    btn.className += " selected";
                }
                updateGraph();
            }
        }

        function toggleDifference() {
            differenceWithPrediction = !differenceWithPrediction;
            var btn = document.getElementById('togglePrediction');
            if (showPrediction == false && differenceWithPrediction == true) {
                showPrediction = true;
                btn.className += " selected";
            }
            var btn2 = document.getElementById('toggleDuration');
            if (showDuration == false && differenceWithPrediction == true) {
                showDuration = true;
                btn2.className += " selected";
            }
            updateGraph();
        }
        function showTimelineBtn() {
            var timelineBtn = document.getElementById('showTimeline');
            var graphBtn = document.getElementById('showGraph');

            if (showTimeline == false) {
                graphBtn.className = graphBtn.className.replace("selected","");
                timelineBtn.className += " selected";
                var timelinewrapper = document.getElementById("timelineWrapper");
                var graphwrapper = document.getElementById("graphWrapper");
                graphwrapper.style.display = "none";
                timelinewrapper.style.display = "block";
                showTimeline = true;
                showGraph = false;
            }
        }
        function showGraphBtn() {
            var timelineBtn = document.getElementById('showTimeline');
            var graphBtn = document.getElementById('showGraph');

            if (showGraph == false) {
                timelineBtn.className = graphBtn.className.replace("selected","");
                graphBtn.className += " selected";
                var timelinewrapper = document.getElementById("timelineWrapper");
                var graphwrapper = document.getElementById("graphWrapper");
                timelinewrapper.style.display = "none";
                graphwrapper.style.display = "block";
                showTimeline = false;
                showGraph = true;
            }
        }

        /**
         * this function fills the external legend with content using the getLegend() function.
         */
        function populateExternalLegend(groupDataItem, description) {
            var legendDiv = document.getElementById("Legend");
            // create divs
            var containerDiv = document.createElement("div");
            var iconDiv = document.createElement("div");
            var descriptionDiv = document.createElement("div");

            // give divs classes and Ids where necessary
            containerDiv.className = 'legendElementContainer';
            containerDiv.id = groupDataItem + "_legendContainer"
            iconDiv.className = "iconContainer";
            descriptionDiv.className = "descriptionContainer";

            // get the legend for this group.
            var legend = graph2d.getLegend(groupDataItem,30,30);

            // append class to icon. All styling classes from the vis.css have been copied over into the head here to be able to style the
            // icons with the same classes if they are using the default ones.
            legend.icon.setAttributeNS(null, "class", "legendIcon");

            // append the legend to the corresponding divs
            iconDiv.appendChild(legend.icon);
            descriptionDiv.innerHTML = description;

            // determine the order for left and right orientation
            if (legend.orientation == 'left') {
                descriptionDiv.style.textAlign = "left";
                containerDiv.appendChild(iconDiv);
                containerDiv.appendChild(descriptionDiv);
            }
            else {
                descriptionDiv.style.textAlign = "right";
                containerDiv.appendChild(descriptionDiv);
                containerDiv.appendChild(iconDiv);
            }

            // append to the legend container div
            legendDiv.appendChild(containerDiv);
        }

    </script>

    <link href="vis.css" rel="stylesheet" type="text/css" />

</head>
<body onload="draw()">
<h1>ARUM - Prague Demonstration</h1>
<div class="typeButton selected" onclick="showTimelineBtn()" id="showTimeline">Show by Timeline</div>
<div class="typeButton" onclick="showGraphBtn()" id="showGraph">Show by Job</div>
<div id="timelineWrapper">
    <input type="button" value="Next Event" onclick="getNewEvent()">
    eventNo:<div id="eventCounter" style="display:inline;">-1</div>
    <input type="button" value="Next 10 Events" onclick="getTenNewEvents()">
    <input type="button" value="Get All Events." onclick="getAllEvents()"> <br>
    <div id="timeline"></div>
</div>


<!--<input type="button" value="refreshJobs" onclick="refreshJobs()">-->
<div id="graphWrapper">
    <table class="wrapper">
        <tr>
            <td id="selectTD">
                <select name="jobs" id="multiselect" multiple onclick="updateGraph()"></select>
            </td>
            <td id="graphTD">
                <div class="typeButtons">
                    <div class="typeButton selected" onclick="turnOn('duration')" id="duration">Ideal</div>
                    <div class="typeButton" onclick="turnOn('durationWithPause')" id="durationWithPause">Ideal + Pause</div>
                    <div class="typeButton" onclick="turnOn('durationWithStartup')" id="durationWithStartup">Ideal + Prerequisites</div>
                    <div class="typeButton" onclick="turnOn('durationWithBoth')" id="durationWithBoth">Total Time</div>
                    <div class="toggleButton" onclick="togglePrediction()" id="togglePrediction">Prediction</div>
                    <input type="button" onclick="toggleDifference()" id="difference" value="Switch View">
                </div>
                <div class="graph2dContent">
                    <div id="graph2d"></div>
                </div>
            </td>
        </tr>
    </table>
    <div id="Legend" class="externalLegend"></div>
</div>

<p id="selection"></p>
<p id="stabilization"></p>
</body>
</html>
